var upload_action=reqContextPath+"/user/home/file/upload";var progressbarNum=1;var moveToDestDirId=0;var prev=1;var next=1;var deleting=false;var creatingShare=false;var creatingNewDir=false;var movingDirs=false;var renamingDir=false;var gettingDir=false;var creatingOffline=false;var gettingOfflineList=false;var gettingList=false;var cancellingOffline=false;var clickedCancelOfflineBtn=null;var uploadWithMD5Check=true;var checkingMD5=false;var uploadingFilesCount=0;var readyList=new HashMap();var errorList=new HashMap();var pieceFileUploadList=new HashMap();var maxUploadingFiles=2;var uploadWithPiece=false;var pieceSize=5242880;var uploadingPieceCount=0;var maxUploadingPiece=8;var blobSlice=File.prototype.slice||File.prototype.mozSlice||File.prototype.webkitSlice;var pieceMaxErrorToCancel=33;var pieceUploadTimeout=120*1000;var resetPieceErrorCountInterval=180*1000;var creatingDirInMove=false;var maxUploadPieceFileSizeTotal=31457280;var creatingUUIDPieceFileCount=0;var shiftKeyPressed=false;var lastCheckBoxId=0;var getListAjax=null;var getDirsAjax=null;var getOfflineListAjax=null;var delayCounter=15;var delayCounterLen=5;var desktopMode=false;$(function(){$(window).bind("hashchange",function(){var f=$(location).prop("href");var g=f.indexOf("#");if(g>0&&g+1!==f.length){var m=[];var k=f.substring(g+1,f.length);var e=k.split("&");for(var h in e){var j=e[h];if(j.match(/[^=]+=[^=]*/)){var l=j.split("=");m[l[0]]=l[1]}}if(m.hasOwnProperty("id")){if(m.hasOwnProperty("page")){getDirs(m.id,m.page)}else{getDirs(m.id)}}}});if(window.innerWidth>=768){$('a[href^="#collapse0"]').click();desktopMode=true}$(document).keydown(function(e){if(e.keyCode===17){shiftKeyPressed=true}});$(document).keyup(function(){if(event.keyCode===17){shiftKeyPressed=false}});var d=$(location).prop("href");var c=d;var b=d.indexOf("#");if(b>0){d=d.substring(0,b)}var a=d+"#id="+currentDirId+"&page="+currentPage;if(c===a||desktopMode){getDirs(currentDirId,currentPage)}else{$(location).prop("href",a)}$("#selectAll").bind("click",function(){$('input[type^="checkbox"]').prop("checked",true);lastCheckBoxId=0});$("#selectNone").bind("click",function(){$('input[type^="checkbox"]').prop("checked",false);lastCheckBoxId=0});$("#selectReverse").bind("click",function(){var f=$('input[type^="checkbox"]');for(var e=0;e<f.length;e++){$(f[e]).prop("checked",!$(f[e]).prop("checked"))}lastCheckBoxId=0});$("#offlineList-table").on("click",".cancelOfflineBtn",function(){if(clickedCancelOfflineBtn===this){if(!cancellingOffline){cancellingOffline=true;var f=$(this).parent().parent().children()[0];var e=$($(f).find("input")[0]).val();$.ajax({url:reqContextPath+"/user/home/file/cancelOffline.do",type:"GET",dataType:"json",data:{filename:e},success:function(h,g,j){if(h.code===0){$.tips("取消成功");getOfflineList()}else{if(h.code===2001){window.location.href=reqContextPath+"/user/login";return}else{$.tips(h.msg)}}cancellingOffline=false},error:function(j,g,h){$.tips("服务器连接失败");cancellingOffline=false}})}}else{clickedCancelOfflineBtn=this;$.tips("再次点击以确认")}});$("#getOfflineListBtn").bind("click",function(){getOfflineList()});$("#myOffline").bind("click",function(){$("#offlineListBtn").click();getOfflineList()});$("#confirmOfflineBtn").bind("click",function(){var e;if(!creatingOffline&&(e=$("#offlineUrl").val())!=null&&e.length>0){creatingOffline=true;$("#closeOfflineBtn").click();$.load();$.ajax({url:reqContextPath+"/user/home/file/offline.do",type:"POST",dataType:"json",data:{url:e},success:function(g,f,h){$.loaded();if(g.code===0){$.tips("创建成功")}else{if(g.code===2001){window.location.href=reqContextPath+"/user/login";return}else{$.tips(g.msg)}}creatingOffline=false},error:function(h,f,g){$.loaded();$.tips("服务器连接失败");creatingOffline=false}})}});$("#createOfflineView").bind("click",function(){$("#offlineBtn").click();$("#offlineUrl").val("");var e=setInterval(function(){clearInterval(e);$("#offlineUrl")[0].focus()},600)});$("#confirmRenameBtn").bind("click",function(){if(!renamingDir){var e=$("#rename-dir-name").val();if(e!=null&&e.length>0){renamingDir=true;$.ajax({url:reqContextPath+"/user/home/file/renameDir.do",type:"POST",dataType:"json",data:{dirId:$("#rename-dir-id").val(),newName:e},success:function(g,f,h){if(g.code===0){$.tips("修改成功");$("#closeRenameViewBtn").click();getDirs(currentDirId,currentPage)}else{if(g.code===2001){window.location.href=reqContextPath+"/user/login";return}else{$.tips(g.msg)}}renamingDir=false},error:function(h,f,g){$.tips("服务器连接失败");renamingDir=false}})}}});$("#table-dir").on("click",".renameBtn",function(){var e=$(this).parent().parent().children()[0];var g=$(e).find("a").text().trim();var h=$(e).find("label").attr("for");$("#rename-dir-name").val(g);$("#rename-dir-id").val(h);$("#showRenameViewBtn").click();var f=setInterval(function(){$("#rename-dir-name")[0].focus();clearInterval(f)},600)}).on("click",".table-dir-a",function(){keywords="";var j=$(this).attr("id");j=j.substring(6);var h=$(location).prop("href");var g=h;var f=h.indexOf("#");if(f>0){h=h.substring(0,f)}var e=h+"#id="+j;if(g===e||desktopMode){getDirs(j)}else{$(location).prop("href",e)}}).on("click",'input[type^="checkbox"]',function(){var j=lastCheckBoxId;if($(this).prop("checked")){lastCheckBoxId=$(this).attr("id")}else{lastCheckBoxId=0}if(shiftKeyPressed&&j>0&&lastCheckBoxId>0){var f=$(this).parent().parent().parent().parent().find('input[type^="checkbox"]');var e=0;for(var h=0;h<f.length;h++){var g=$(f[h]).attr("id");if(g===j||g===lastCheckBoxId){e++;if(e===2){break}}if(e===1){$(f[h]).prop("checked",true)}}lastCheckBoxId=j}});$("#pathInfo").on("click",".table-dir-a",function(){keywords="";var h=$(this).attr("id");h=h.substring(6);var g=$(location).prop("href");var f=g;var e=g.indexOf("#");if(e>0){g=g.substring(0,e)}a=g+"#id="+h;if(f===a||desktopMode){getDirs(h)}else{$(location).prop("href",a)}});$("#confirmCreateDirBtn").bind("click",function(){if(!creatingNewDir){var f=currentDirId;var e=$("#new-dir-name").val();if(e!==null&&e.length>0){$.load();$("#closeCreateDirViewBtn").click();creatingNewDir=true;$.ajax({url:reqContextPath+"/user/home/file/createDir.do",type:"POST",dataType:"json",data:{pid:f,dirName:e},success:function(h,g,j){$.loaded();if(h.code===0){$.tips("新建成功！");getDirs(currentDirId,currentPage)}else{if(h.code===2001){window.location.href=reqContextPath+"/user/login";return}else{$.tips(h.msg)}}creatingNewDir=false},error:function(j,g,h){$.loaded();$.tips("服务器连接失败");creatingNewDir=false}})}else{$.tips("输入为空")}}});$("#createNewDir").bind("click",function(){$("#new-dir-name").val("");$("#showCreateDirViewBtn").click();var e=setInterval(function(){$("#new-dir-name")[0].focus();clearInterval(e)},600)});$("#confirm-move-btn").bind("click",function(){if(!movingDirs){$("#close-move-to-btn").click();$.load();movingDirs=true;var e=$("#checkBoxForm");$.ajax({url:reqContextPath+"/user/home/index/moveTo.do?pid="+moveToDestDirId,type:"POST",dataType:"json",data:$(e).serialize(),success:function(g,f,h){$.loaded();if(g.code===0){$.tips("移动成功！");getDirs(currentDirId,currentPage)}else{if(g.code===2001){window.location.href=reqContextPath+"/user/login";return}else{$.tips(g.msg)}}movingDirs=false},error:function(h,f,g){$.loaded();$.tips("服务器连接失败");movingDirs=false}})}});$("#move-upper-dir").bind("click",function(){getList(moveToDestDirId,2)});$("#move-list-table").on("click",".table_a",function(){getList($(this).attr("dir_id"))});$("#move-dir_name").on("click",".table_a",function(){getList($(this).attr("dir_id"))});$("#moveTo").bind("click",function(){$("#showMoveToList").click();$("#dirNameInMove").val("");getList(moveToDestDirId)});$("#createShare").bind("click",function(){if(!creatingShare){var e=$("#checkBoxForm").serialize();if(e.length===0){$.tips("还没有选择");return}var h=$($($($("#createShareTimeType1").parent()).parent()).find(".modal-body")).find("label");var f=h[0];var g=h[1];$(f).addClass("active");$(g).removeClass("active");$("#createShareBtn").click()}});$("#createShareTimeType1").bind("click",function(){var f=$($($($(this).parent()).parent()).find(".modal-body")).find("label")[1];var e=1;if($(f).hasClass("active")){e=2}createShare(e,1);$("#closeCreateShareBtn").click()});$("#createShareTimeType2").bind("click",function(){var f=$($($($(this).parent()).parent()).find(".modal-body")).find("label")[1];var e=1;if($(f).hasClass("active")){e=2}createShare(e,2);$("#closeCreateShareBtn").click()});$("#copyShareBtn").bind("click",function(){copy2clipboard($(this).attr("data-sort"))});$("#multiDel").bind("click",function(){var e=$(checkBoxForm).serialize();if(e.length===0){$.tips("还没有选择");return}$.confirm("确定删除？",function(g){if(g&&!deleting){deleting=true;var f=$("#checkBoxForm");$.ajax({url:reqContextPath+"/user/home/file/multiDel.do",type:"POST",data:e,dataType:"json",success:function(j,h,k){if(j.code===0){$.tips("删除成功！");getDirs(currentDirId,currentPage)}else{if(j.code===2001){window.location.href=reqContextPath+"/user/login";return}else{$.tips(j.msg)}}deleting=false;return true},error:function(k,h,j){$.tips("服务器连接失败");deleting=false;return true}})}else{return true}}).cancel("不是，点错了").ok("是的")});$("#searchBtn").bind("click",function(){keywords=$("#searchText").val();getDirs(currentDirId,currentPage)});$("#cancelSearchBtn").bind("click",function(){$("#searchText").val("");$("#searchBtn").click()});$("#searchText").keydown(function(e){if(e.keyCode===13){keywords=$("#searchText").val();getDirs(currentDirId,currentPage);return false}});$("#prevBtn").bind("click",function(){if(currentPage===prev){$.tips("到头了")}else{var f=$(location).prop("href");var e=f.indexOf("#");if(e>0){f=f.substring(0,e)}if(desktopMode){getDirs(currentDirId,prev)}else{$(location).prop("href",f+"#id="+currentDirId+"&page="+prev)}}});$("#nextBtn").bind("click",function(){if(currentPage===next){$.tips("到底了")}else{var f=$(location).prop("href");var e=f.indexOf("#");if(e>0){f=f.substring(0,e)}if(desktopMode){getDirs(currentDirId,next)}else{$(location).prop("href",f+"#id="+currentDirId+"&page="+next)}}});$("#input-file").bind("change",function(){var g=currentDirId;var k=uploadWithMD5Check;var f=uploadWithPiece;var e=$("#input-file");var h=e[0].files;if(h==null||h.length===0){return false}for(var j=0;j<h.length;j++){h[j].toUploadDirId=g;h[j].uploadWithMD5Check=k;h[j].uploadWithPiece=f;readyList.put(h[j]);updateUploadWaitList()}e.val("")});$("#input-dir").bind("change",function(){var g=currentDirId;var k=uploadWithMD5Check;var f=uploadWithPiece;var e=$("#input-dir");var h=e[0].files;if(h==null||h.length===0){return false}for(var j=0;j<h.length;j++){h[j].toUploadDirId=g;h[j].uploadWithMD5Check=k;h[j].uploadWithPiece=f;readyList.put(h[j]);updateUploadWaitList()}e.val("")});$("#a-upload-file").bind("click",function(){uploadWithMD5Check=false;uploadWithPiece=false;$("#input-file").click()});$("#a-upload-file-md5").bind("click",function(){uploadWithMD5Check=true;uploadWithPiece=false;$("#input-file").click()});$("#a-upload-dir").bind("click",function(){uploadWithMD5Check=false;uploadWithPiece=false;$("#input-dir").click()});$("#a-upload-dir-md5").bind("click",function(){uploadWithMD5Check=true;uploadWithPiece=false;$("#input-dir").click()});$("#a-upload-file-piece").bind("click",function(){uploadWithMD5Check=false;uploadWithPiece=true;$("#input-file").click()});$("#a-upload-dir-piece").bind("click",function(){uploadWithMD5Check=false;uploadWithPiece=true;$("#input-dir").click()});$("#a-upload-file-piece-md5").bind("click",function(){uploadWithMD5Check=true;uploadWithPiece=true;$("#input-file").click()});$("#a-upload-dir-piece-md5").bind("click",function(){uploadWithMD5Check=true;uploadWithPiece=true;$("#input-dir").click()});$("#myUploadList").bind("click",function(){$("#uploadListBtn").click()});$("#uploadList-error-table").on("click",".cancelUploadBtn",function(){var e=$($(this).parent().parent().find("input")[0]).val();errorList.remove(e);updateUploadErrorList()}).on("click",".retryUploadBtn",function(){var f=$($(this).parent().parent().find("input")[0]).val();var e=errorList.obj[f];readyList.put(e);updateUploadWaitList();errorList.remove(f);updateUploadErrorList()});$("#uploadList-wait-table").on("click",".cancelUploadBtn",function(){var e=$($(this).parent().parent().find("input")[0]).val();readyList.remove(e);updateUploadWaitList();$.tips("取消成功")});$("#createDirInMoveBtn").bind("click",function(){var e=$("#dirNameInMove").val();if(e==null||e.length===0){return}if(!creatingDirInMove){creatingDirInMove=true;$.ajax({url:reqContextPath+"/user/home/file/createDir.do",type:"POST",dataType:"json",data:{pid:moveToDestDirId,dirName:e},success:function(g,f,h){if(g.code===0){$.tips("创建成功！");$("#dirNameInMove").val("");getList(moveToDestDirId,1)}else{if(g.code===2001){window.location.href=reqContextPath+"/user/login";return}}creatingDirInMove=false},error:function(h,f,g){$.tips("创建目录失败");creatingDirInMove=false}})}});$("#sort-filename").bind("click",function(){var e=1;if(currentSort===1||currentSort===2){if(currentSort===1){e=2}else{e=1}}getDirs(currentDirId,1,e)});$("#sort-size").bind("click",function(){var e=4;if(currentSort===3||currentSort===4){if(currentSort===3){e=4}else{e=3}}getDirs(currentDirId,1,e)});$("#sort-create").bind("click",function(){var e=6;if(currentSort===5||currentSort===6){if(currentSort===5){e=6}else{e=5}}getDirs(currentDirId,1,e)});setInterval(function(){var e=readyList.getOneKey();if(e==null){return}var m=readyList.obj[e];if(checkingMD5&&m.uploadWithMD5Check){return}var l=true;if(uploadingFilesCount<maxUploadingFiles){l=false}if(l&&m.uploadWithPiece){if(creatingUUIDPieceFileCount===0){var f=0;var j=0;for(var k in pieceFileUploadList.obj){if(pieceFileUploadList.obj.hasOwnProperty(k)){j++;f+=pieceFileUploadList.obj[k].size}}if(f<=maxUploadPieceFileSizeTotal&&j<maxUploadingPiece){l=false}}}if(l){return}readyList.remove(e);updateUploadWaitList();$("#statusBars").append($("<div></div>").attr("class","progress progress-striped active").append($("<div></div>").attr("class","progress-bar").attr("role","progressbar").attr("aria-valuenow","60").attr("aria-valuemin","0").attr("aria-valuemax","100").attr("id","progress"+progressbarNum).append($("<div></div>").attr("class","div-info-txt").append($("<span></span>").attr("id","span"+progressbarNum)).append("&nbsp;").append($("<span></span>").attr("id","spanPTG"+progressbarNum).text("0%")))));var g=$("#progress"+progressbarNum);var h=$("#span"+progressbarNum);var n=$("#spanPTG"+progressbarNum);progressbarNum++;$(g).css("width","0");var o={};o.canceled=false;o.calculateMD5=m.uploadWithMD5Check;m.progressbarPTG=n;if(m.uploadWithPiece){m.combining=false;m.pieceInfo={total:Math.ceil(m.size/pieceSize)};m.ajaxObjs=[];m.progressbar=g;m.objCancel=o;m.pieceErrorCount=0;$(g).parent().bind("click",function(){if(m.objCancel.calculateMD5){return}$.confirm("取消上传 "+getShortenFileName(m.name,22)+" ？",function(q){if(q){o.canceled=true;$(g).parent().remove();for(var p=0;p<m.ajaxObjs.length;p++){if(m.ajaxObjs[p]!=null){m.ajaxObjs[p].abort()}}uploadingFilesCount--;return true}else{return true}}).cancel("不是，点错了").ok("是，取消")})}if(m.uploadWithMD5Check){$(g).parent().bind("click",function(){if(o.calculateMD5){$.confirm("取消上传 "+getShortenFileName(m.name,22)+" ？",function(p){if(p){o.canceled=true;return true}else{return true}}).cancel("不是，点错了").ok("是，取消")}});$(g).addClass("progress-bar-success");$(h).text("计算MD5..");get_file_md5_sum(m,g,h,o)}else{$(g).addClass("progress-bar-info");$(h).text(getShortenFileName(m.name));if(m.uploadWithPiece){creatingUUIDPieceFileCount++;uploadingFilesCount++;$.ajax({url:reqContextPath+"/user/home/file/createPieceUpload.do",type:"POST",data:{filename:m.name,pid:m.toUploadDirId,relativePath:m.webkitRelativePath,totalPiece:m.pieceInfo.total},dataType:"json",success:function(r,p,s){creatingUUIDPieceFileCount--;if(r.code===0){var q=r.uuid;if(q.length>0){m.uuid=q;pieceFileUploadList.put(m)}else{uploadingFilesCount--;g.parent().remove();errorList.put(m);updateUploadErrorList()}}else{if(r.code===2001){window.location.href=reqContextPath+"/user/login"}else{uploadingFilesCount--;g.parent().remove();errorList.put(m);updateUploadErrorList()}}},error:function(r,p,q){creatingUUIDPieceFileCount--;uploadingFilesCount--;m.progressbar.parent().remove();errorList.put(m);updateUploadErrorList()}})}else{uploadFile(m,g,o)}}},200);setInterval(function(){if(uploadingPieceCount<maxUploadingPiece){if(uploadingPieceCount*2<maxUploadingPiece){delayCounter=delayCounterLen}else{if(delayCounter<=delayCounterLen){delayCounter++}}var m=pieceFileUploadList.obj;for(var h in m){if(m.hasOwnProperty(h)){var g=m[h];if(g.objCancel.canceled){delete m[h];return}if(g.pieceErrorCount>=pieceMaxErrorToCancel){delete m[h];g.objCancel.canceled=true;g.progressbar.parent().remove();for(var l=0;l<g.ajaxObjs.length;l++){if(g.ajaxObjs[l]!=null){g.ajaxObjs[l].abort()}}errorList.put(g);updateUploadErrorList();uploadingFilesCount--;return}if(g.hasOwnProperty("pieceInfo")){var f=g.pieceInfo;var e=true;var k=0;for(var j=1;j<=f.total;j++){if(f[j]===undefined||f[j]<96){e=false}if(delayCounter>=delayCounterLen&&(f[j]===undefined||f[j]===0)){k=j}if(!e&&(delayCounter<delayCounterLen||k!==0)){break}}if(delayCounter>=delayCounterLen){if(k!==0){delayCounter=0;f[k]=1;uploadingPieceCount++;uploadPiece(g,k)}}if(e&&!g.combining){g.combining=true;(function(p,o){var n=setInterval(function(){clearInterval(n);o.ajaxObjs[o.ajaxObjs.length]=$.ajax({url:reqContextPath+"/user/home/file/finishUpload.do",dataType:"json",type:"GET",data:{uuid:o.uuid},success:function(r,q,s){delete m[p];uploadingFilesCount--;o.progressbar.parent().remove();if(r.code===0){$.tips("文件 "+getShortenFileName(o.name)+" 上传成功");if(currentDirId===o.toUploadDirId){getDirs(currentDirId,currentPage)}}else{if(r.code===2001){window.location.href=reqContextPath+"/user/login"}else{errorList.put(o);updateUploadErrorList();$.tips(r.msg);console.log(r.msg)}}},error:function(s,q,r){if(s.status===524||s.status===504){$.tips("文件 "+getShortenFileName(o.name)+" 上传成功，但还在处理");if(currentDirId===o.toUploadDirId){getDirs(currentDirId,currentPage)}}else{errorList.put(o);updateUploadErrorList()}o.progressbar.parent().remove();delete m[p];uploadingFilesCount--}})},2000)})(h,g)}}}}}},200);setInterval(function(){var l=pieceFileUploadList.obj;for(var h in l){if(l.hasOwnProperty(h)){var g=l[h];var f=g.pieceInfo;var j=0;for(var k=1;k<=f.total;k++){if(f[k]!==undefined&&f[k]>0){j+=f[k]}}var e=Math.ceil(j/f.total);g.progressbar.css("width",e+"%");g.progressbarPTG.text(e+"%")}}},2000);setInterval(function(){var g=pieceFileUploadList.obj;for(var f in g){if(g.hasOwnProperty(f)){var e=g[f];e.pieceErrorCount=0}}},resetPieceErrorCountInterval)});function createShare(b,c){if(!creatingShare){var a=$("#checkBoxForm").serialize();if(a.length===0){$.tips("还没有选择");return}creatingShare=true;if(b==null||b!==2){b=1}else{b=2}if(c==null||c!==2){c=1}else{c=2}a+=("&type="+b+"&timeType="+c);$.load("正在创建..");$.ajax({url:reqContextPath+"/user/home/file/createShare.do",type:"POST",dataType:"json",data:a,success:function(h,d,k){$.loaded();var l=$("#openShareBtn");var f=$("#copyShareBtn");if(h.code===0){var e=window.location.protocol+"//"+window.location.host+"/share/show/"+h.share_id;var g=h.share_code;var j=e;if(g.length>0){j+=(" 密码： "+g)}$(f).attr("data-sort",j);$(f).attr("disabled",false);$(l).attr("disabled",false);$(l).attr("href",reqContextPath+"/user/home/share?newId="+h.share_id);$("#createShareResultText").text("创建分享成功！")}else{if(h.code===2001){window.location.href=reqContextPath+"/user/login";return}else{$(l).attr("disabled",true);$(f).attr("disabled",true);$("#createShareResultText").text(h.msg)}}$("#shareResultBtn").click();creatingShare=false},error:function(f,d,e){$.loaded();$.tips("服务器连接失败");creatingShare=false}})}}function updateUploadErrorList(){var a=$("#uploadList-error-table").find("tbody");a.empty();for(var b in errorList.obj){a.append($("<tr></tr>").append($("<td></td>").text(getShortenFileName(errorList.obj[b].name,20)).append($("<input>").attr("type","hidden").attr("value",b))).append($("<td></td>").text(getFormatSize(errorList.obj[b].size))).append($("<td></td>").attr("class","errorListTD").append($("<button></button>").attr("class","btn btn-info retryUploadBtn").attr("type","button").text("重试")).append($("<button></button>").attr("class","btn btn-danger cancelUploadBtn").attr("type","button").text("取消"))))}}function updateUploadWaitList(){var a=$("#uploadList-wait-table").find("tbody");a.empty();for(var b in readyList.obj){a.append($("<tr></tr>").append($("<td></td>").text(getShortenFileName(readyList.obj[b].name,20)).append($("<input>").attr("type","hidden").attr("value",b))).append($("<td></td>").text(getFormatSize(readyList.obj[b].size))).append($("<td></td>").attr("class","waitListTD").append($("<button></button>").attr("class","btn btn-danger cancelUploadBtn").attr("type","button").text("取消"))))}}function addFile(d,e,b,c){c.calculateMD5=false;var a=$.ajax({url:upload_action,type:"POST",dataType:"json",data:{pid:d.toUploadDirId,md5:e,filename:d.name,relativePath:d.webkitRelativePath},success:function(g,f,h){if(g.code===0){$(b).css("width","100%");$(b).parent().remove();$.tips(getShortenFileName(d.name)+"秒传成功！");if(currentDirId===d.toUploadDirId){getDirs(currentDirId,currentPage)}}else{$(b).parent().remove();$.tips(getShortenFileName(d.name)+"秒传失败！");console.log(g.msg)}},error:function(h,f,g){if(c.canceled){$.tips(getShortenFileName(d.name)+"秒传取消！")}else{errorList.put(d);updateUploadErrorList();$.tips(getShortenFileName(d.name)+"秒传失败！")}$(b).parent().remove()}});$(b).parent().bind("click",function(){$.confirm("取消上传 "+getShortenFileName(d.name)+" ？",function(f){if(f){c.canceled=true;a.abort()}return true}).cancel("不是，点错了").ok("是，取消")})}function uploadFile(d,a,b){uploadingFilesCount++;b.calculateMD5=false;var c=new FormData();c.append("file",d);c.append("pid",d.toUploadDirId);c.append("relativePath",d.webkitRelativePath);var e=$.ajax({processData:false,cache:false,contentType:false,url:upload_action,type:"POST",data:c,xhr:function(){var f=$.ajaxSettings.xhr();if(f.upload){f.upload.addEventListener("progress",function(g){if(g.lengthComputable){$(a).css("width",Math.round(g.loaded*95/g.total)+"%");d.progressbarPTG.text(Math.round(g.loaded*95/g.total)+"%")}})}return f},success:function(g,f,h){$(a).css("width","100%");$(a).parent().remove();$.tips(getShortenFileName(d.name)+"上传成功！");if(currentDirId===d.toUploadDirId){getDirs(currentDirId,currentPage)}uploadingFilesCount--},error:function(h,f,g){if(b.canceled){$.tips(getShortenFileName(d.name)+"上传取消！")}else{errorList.put(d);updateUploadErrorList();$.tips(getShortenFileName(d.name)+"上传失败！")}$(a).parent().remove();uploadingFilesCount--}});$(a).parent().bind("click",function(){$.confirm("取消上传 "+getShortenFileName(d.name)+" ？",function(f){if(f){b.canceled=true;e.abort()}return true}).cancel("不是，点错了").ok("是，取消")})}function uploadPiece(d,e){var b=new FileReader();var a=new SparkMD5.ArrayBuffer();var f=(e-1)*pieceSize;var c;if((c=e*pieceSize)>d.length){c=d.length}b.onerror=function(g){uploadingPieceCount--;d.pieceInfo[e]=0};b.onload=function(k){a.append(k.target.result);var g=a.end();if(d.objCancel.canceled){return}var j=new FormData();j.append("pieceNum",e);j.append("uuid",d.uuid);j.append("pieceFile",d.slice(f,c));j.append("pieceMD5",g);var h=d.ajaxObjs.length;d.ajaxObjs[h]=$.ajax({url:reqContextPath+"/user/home/file/uploadPiece.do",type:"POST",dataType:"json",timeout:pieceUploadTimeout,processData:false,cache:false,contentType:false,data:j,xhr:function(){var l=$.ajaxSettings.xhr();if(l.upload){l.upload.addEventListener("progress",function(m){if(m.lengthComputable&&d.pieceInfo[e]>0){var n=Math.round(m.loaded*95/m.total);if(n===0){n=1}d.pieceInfo[e]=n}})}return l},success:function(m,l,n){if(m.code===0){d.pieceInfo[e]=96;d.ajaxObjs[h]=null;uploadingPieceCount--}else{if(m.code===2001){window.location.href=reqContextPath+"/user/login"}else{d.ajaxObjs[h]=null;d.pieceInfo[e]=0;uploadingPieceCount--;d.pieceErrorCount++}}},error:function(n,l,m){d.ajaxObjs[h]=null;d.pieceInfo[e]=0;uploadingPieceCount--;d.pieceErrorCount++}})};b.readAsArrayBuffer(blobSlice.call(d,f,c))}function get_file_md5_sum(b,f,j,n){checkingMD5=true;var h=new Date();var a=h.getTime();var e;var c=8097152,g=Math.ceil(b.size/c),m=0,k=new SparkMD5.ArrayBuffer(),d=new FileReader();d.onload=function(q){k.append(q.target.result);m++;var p=Math.floor((m/g)*100);h=new Date();var o=h.getTime();if(o-a>600){$(f).css("width",p+"%");a=o}if(n.canceled){checkingMD5=false;$(f).parent().remove();return}if(m<g){l()}else{e=k.end();$.ajax({url:reqContextPath+"/user/home/file/checkMD5",type:"POST",data:{md5:e},success:function(s,r,t){$(f).css("width","100%");$(j).text(getShortenFileName(b.name));$(f).removeClass("progress-bar-success");$(f).addClass("progress-bar-info");$(f).css("width","0");if(s==="true"){addFile(b,e,f,n)}else{if(b.uploadWithPiece){creatingUUIDPieceFileCount++;uploadingFilesCount++;$.ajax({url:reqContextPath+"/user/home/file/createPieceUpload.do",type:"POST",data:{filename:b.name,pid:b.toUploadDirId,relativePath:b.webkitRelativePath,totalPiece:b.pieceInfo.total},dataType:"json",success:function(w,u,x){creatingUUIDPieceFileCount--;if(w.code===0){var v=w.uuid;if(v.length>0){b.uuid=v;pieceFileUploadList.put(b);n.calculateMD5=false}else{uploadingFilesCount--;f.parent().remove();errorList.put(b);updateUploadErrorList()}}else{if(w.code===2001){window.location.href=reqContextPath+"/user/login"}else{uploadingFilesCount--;f.parent().remove();errorList.put(b);updateUploadErrorList()}}},error:function(w,u,v){creatingUUIDPieceFileCount--;uploadingFilesCount--;b.progressbar.parent().remove();errorList.put(b);updateUploadErrorList()}})}else{uploadFile(b,f,n)}}checkingMD5=false},error:function(t,r,s){$(f).parent().remove();$.tips(getShortenFileName(b.name)+"查询MD5失败！");console.log(s);checkingMD5=false}})}};d.onerror=function(){console.warn("oops, something went wrong.");$(f).parent().remove();$.tips(getShortenFileName(b.name)+"MD5计算失败！");checkingMD5=false};function l(){var p=m*c,o=((p+c)>=b.size)?b.size:p+c;d.readAsArrayBuffer(blobSlice.call(b,p,o))}l()}function getShortenFileName(b,c){var e=b.length;var d="";var h=0;for(i=0;i<e;i++){if((b.charCodeAt(i)&65280)!==0){h++}h++}var g=0;var a=12;var j=4;if(c!=null&&c>0){if(c%2!==0){c--}a=c;j=(c-4)/2}if(h>=a){for(i=0;i<e;i++){if((b.charCodeAt(i)&65280)!==0){g++}g++;if(g>j){break}d+=b.charAt(i)}g=0;var f="";for(i=e-1;i>=0;i--){if((b.charCodeAt(i)&65280)!==0){g++}g++;if(g>j){break}f=b.charAt(i)+f}d+="..."+f;return d}else{return b}}function getOfflineList(){clickedCancelOfflineBtn=null;var a=$("#offlineList-table").find("tbody");a.empty();$("#offlineListInfo").text("加载中..");if(getOfflineListAjax!=null){getOfflineListAjax.abort()}getOfflineListAjax=$.ajax({url:reqContextPath+"/user/home/file/offlineList.do",type:"GET",dataType:"json",data:{},success:function(d,b,e){if(d.code===2001){window.location.href=reqContextPath+"/user/login";return}$("#offlineListInfo").text("列表");for(var c=0;c<d.length;c++){a.append($("<tr></tr>").append($("<td></td>").text(getShortenFileName(d[c].originalFilename,20)).append($("<input>").attr("value",d[c].filename).attr("type","hidden"))).append($("<td></td>").text(getFormatSize(d[c].length))).append($("<td></td>").text(getLocalTime(d[c].last_update))).append($("<td></td>").attr("class","cancelOfflineTD").append($("<button></button>").attr("type","button").attr("class","btn btn-info cancelOfflineBtn").text("取消"))))}},error:function(d,b,c){if(b!=="abort"){$.tips("获取离线列表失败");$("#offlineListInfo").text("加载失败")}}})}function getDirs(d,c,a){if(d==null){d=0}if(c==null||c===0){c=1}if(a==null||a<1||a>6){a=currentSort}var b;if(keywords==null||keywords.length===0){if(isSearch){c=1}isSearch=false;b={pid:d,page:c,sort:a}}else{if(!isSearch){c=1}isSearch=true;b={keywords:keywords,page:c,sort:a}}$.tips("正在刷新");if(getDirsAjax!=null){getDirsAjax.abort()}getDirsAjax=$.ajax({url:reqContextPath+"/user/home/index.do",type:"GET",dataType:"json",data:b,success:function(h,f,p){if(h.code===2001){window.location.href=reqContextPath+"/user/login";return}var k=$("#table-dir").find("tbody");var l=$("#pathInfo");$(k).empty();$(l).empty();currentDirId=h.currentDirId;next=h.next;prev=h.prev;currentPage=h.currentPage;currentSort=h.currentSort;var m=h.userDirs;var n=h.aboveDirList;if(n.length>0){$(l).append('<i class="fa fa-home" aria-hidden="true"></i>&nbsp;');for(var e=0;e<n.length-1;e++){$(l).append($('<a href="javascript:void(0)" id="a-pid-'+n[e].id+'" class="table-dir-a"></a>').text(n[e].name)).append(" > ")}$(l).append($('<a href="javascript:void(0)" id="a-pid-'+n[e].id+'" class="table-dir-a"></a>').text(n[e].name))}for(var g=0;g<m.length;g++){var q;var o;if(m[g].is_dir===1){q="--";o='<i class="fa fa-folder-open-o" aria-hidden="true"></i>&nbsp;<a href="javascript:void(0)" id="a-pid-'+m[g].id+'" class="table-dir-a">'+m[g].name+"</a>"}else{q=getFormatSize(m[g].file_length);o='<i class="fa fa-file-text-o" aria-hidden="true"></i>&nbsp;<a target="_blank" download="'+m[g].name+'" href="'+h.prjPath+"/user/home/file/download/"+m[g].id+"/"+h.token+"/"+encodeURI(m[g].name)+'">'+m[g].name+"</a>"}$(k).append($("<tr></tr>").append($("<td></td>").append($('<div class="checkbox checkbox-primary checkbox-div"></div>').append($('<input form="checkBoxForm" name="ids[]" id="'+m[g].id+'" value="'+m[g].id+'" class="styled" type="checkbox">')).append($('<label for="'+m[g].id+'"></label>'))).append($(o))).append($("<td></td>").text(q)).append($("<td></td>").text(getLocalTimeWithoutSeconds(m[g].create_time))).append($("<td></td>").attr("class","renameTD").append($('<button class="btn btn-info renameBtn" type="button">重命名</button>'))))}$.tips("刷新成功")},error:function(g,e,f){if(e!=="abort"){$.tips("刷新失败！")}}})}function getList(c,a){$("#confirm-move-btn").attr("disabled",true);var b=$("#move-list-table");$(b).empty();$("#move-dir_name").text("加载中..");if(c==null){c=0}if(a==null){a=1}if(getListAjax!=null){getListAjax.abort()}getListAjax=$.ajax({url:reqContextPath+"/user/home/index/dirs.do",type:"GET",dataType:"json",data:{id:c,type:a},success:function(f,d,h){if(f.code===2001){window.location.href=reqContextPath+"/user/login";return}$("#confirm-move-btn").attr("disabled",false);moveToDestDirId=f.currentId;$("#move-dir_name").text(f.currentName);var g=f.dirs;for(var e=0;e<g.length;e++){$(b).append($("<tr></tr>").append($("<td></td>").append($("<a></a>").attr("href","javascript:void(0)").attr("class","table_a").attr("dir_id",g[e].id).text(g[e].name))))}},error:function(f,d,e){if(d!=="abort"){$("#confirm-move-btn").attr("disabled",false);$("#move-dir_name").text("").append($('<a href="javascript:void(0)"></a>').attr("class","table_a").attr("dir_id",c).text("加载失败，点击重试"));$.tips("加载失败")}}})}function HashMap(){this.num=1;this.len=0;this.obj={};this.getData=function(){return this.obj};this.length=function(){return this.len};this.getOneKey=function(){for(var a in this.obj){if(a!=null){return a}}return null};this.pop=function(){for(var a in this.obj){var b=this.obj[a];if(b!=null){this.remove(a);return b}}return null};this.containsKey=function(a){return(a in this.obj)};this.containsValue=function(b){for(var a in this.obj){if(this.obj.hasOwnProperty(a)&&this.obj[a]===b){return true}}return false};this.put=function(a){this.obj[this.num]=a;this.num++;this.len++};this.get=function(a){return this.containsKey(a)?this.obj[a]:null};this.remove=function(a){if(this.containsKey(a)&&delete this.obj[a]){this.len--}}}function isMobile(){var c=navigator.userAgent.toLowerCase();var g=c.match(/ipad/i)==="ipad";var h=c.match(/iphone os/i)==="iphone os";var f=c.match(/midp/i)==="midp";var d=c.match(/rv:1.2.3.4/i)==="rv:1.2.3.4";var e=c.match(/ucweb/i)==="ucweb";var a=c.match(/android/i)==="android";var b=c.match(/windows ce/i)==="windows ce";var j=c.match(/windows mobile/i)==="windows mobile";return g||h||f||d||e||a||b||j}function getFormatSize(a){if(a>1024*1024*1024){return(a/1024/1024/1024).toFixed(2)+"G"}else{if(a>1024*1024){return(a/1024/1024).toFixed(2)+"M"}else{return(a/1024).toFixed(2)+"K"}}}function getLocalTimeWithoutSeconds(d){var e=new Date(parseInt(d)*1000).toLocaleString();var c=e.replace(/:\d{1,2}$/," ").replace(/上午/,"").replace(/下午/,"").replace(/年/,"/").replace(/月/,"/").replace(/日/,"/").split(" ");var a=c[1].split(":");if(e.match(/下午/)){if(a[0]!=="12"){a[0]=parseInt(a[0])+12}}else{if(e.match(/上午/)){if(a[0]==="12"){a[0]=parseInt(a[0])-12}}else{return e}}var b=c[0]+" "+a[0]+":"+a[1];return b}function getLocalTime(a){return new Date(parseInt(a)*1000).toLocaleString("chinese",{hour12:false}).replace(/(上午|下午)/,"")}function copy2clipboard(b){if(b===null||b.length===0){$.tips("文字为空");return}$(document).off("focusin.modal");var a=$("#clipboard");$(a).val(b);$(a)[0].select();document.execCommand("Copy");$.tips("复制完毕！");$(a)[0].blur()};